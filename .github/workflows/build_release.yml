name: æ„å»ºå’Œå‘å¸ƒACE-KILLER

permissions:
  contents: write
  packages: write
  
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'æ­¤ç‰ˆæœ¬åŒ…å«æ€§èƒ½æ”¹è¿›å’Œé”™è¯¯ä¿®å¤'

jobs:
  build:
    name: æ„å»ºWindowsåº”ç”¨
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONLEGACYWINDOWSSTDIO: 1
      PIP_DISABLE_PIP_VERSION_CHECK: 1
      PYTHONOPTIMIZE: 1
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: è®¾ç½®MSYS2/MinGW-w64ç¯å¢ƒ
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: false
          path-type: minimal
          release: false
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-gcc-libs
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-headers-git
            mingw-w64-x86_64-crt-git
            mingw-w64-x86_64-winpthreads-git
          
      - name: é…ç½®ç¼–è¯‘å™¨ç¯å¢ƒ
        shell: msys2 {0}
        run: |
          # éªŒè¯GCCå®‰è£…å’Œç‰ˆæœ¬
          echo "ğŸ”§ éªŒè¯MSYS2 MinGW-w64ç¯å¢ƒ:"
          gcc --version
          g++ --version
          which gcc
          which g++
          
          # æ˜¾ç¤ºç¼–è¯‘å™¨è¯¦ç»†ä¿¡æ¯
          echo "ğŸ“‹ ç¼–è¯‘å™¨è¯¦ç»†ä¿¡æ¯:"
          gcc -v 2>&1 | tail -5
          
          echo "âœ… MSYS2 MinGW-w64ç¯å¢ƒé…ç½®å®Œæˆ"

      - name: ç¼“å­˜PySide6å’ŒNuitka
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            ~/.cache/pip
            ~/.cache/Nuitka
            ~/.local/share/Nuitka
            ~/AppData/Local/pip/Cache
            ~/AppData/Local/Nuitka/Nuitka/Cache
          key: ${{ runner.os }}-pyside6-nuitka-msys2-${{ hashFiles('requirements.txt') }}-v3
          restore-keys: |
            ${{ runner.os }}-pyside6-nuitka-msys2-${{ hashFiles('requirements.txt') }}-
            ${{ runner.os }}-pyside6-nuitka-msys2-
            ${{ runner.os }}-pyside6-nuitka-mingw64-
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          Write-Host "ğŸ“¦ å®‰è£…Pythonä¾èµ–..."
          python -m pip install --upgrade pip wheel --quiet
          pip install "certifi>=2025.4.26" --quiet
          pip install -r requirements.txt --quiet
          pip install nuitka==2.6.7 zstandard ordered-set --quiet
          Write-Host "âœ… Pythonä¾èµ–å®‰è£…å®Œæˆ"
      - name: å‡†å¤‡æ„å»ºç¯å¢ƒ
        run: |
          Write-Host "ğŸ”§ å‡†å¤‡æ„å»ºç¯å¢ƒ..."
          
          # æ›´æ–°ç‰ˆæœ¬å·
          echo "${{ github.event.inputs.version }}" | Out-File -FilePath "VERSION" -Encoding utf8 -NoNewline
          Write-Host "âœ… å·²æ›´æ–° VERSION æ–‡ä»¶ä¸º: ${{ github.event.inputs.version }}"
          
          # æ›´æ–° utils/version_checker.py ä¸­çš„ç‰ˆæœ¬å·
          $versionCheckerPath = "utils/version_checker.py"
          if (Test-Path $versionCheckerPath) {
            (Get-Content -Path $versionCheckerPath -Raw) -replace '__version__ = ".*"', '__version__ = "${{ github.event.inputs.version }}"' | Set-Content -Path $versionCheckerPath -Encoding utf8
            Write-Host "âœ… å·²æ›´æ–° version_checker.py ä¸­çš„ç‰ˆæœ¬å·"
          }
          
          # æ¸…ç†æ„å»ºæ–‡ä»¶
          @("main.dist", "main.build", "main.onefile-build", "nuitka-crash-report.xml") | ForEach-Object {
            if (Test-Path $_) { Remove-Item -Recurse -Force $_ }
          }
          
          # æ¸…ç†Pythonç¼“å­˜
          Get-ChildItem -Path . -Recurse -Name "__pycache__" -ErrorAction SilentlyContinue | ForEach-Object { 
            try { Remove-Item -Recurse -Force $_ } catch { Write-Warning "æ— æ³•åˆ é™¤: $_" }
          }
          
          Write-Host "âœ… æ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ"
        shell: pwsh

      - name: ä½¿ç”¨Nuitkaæ‰“åŒ…åº”ç”¨ç¨‹åº
        run: |
          # æ£€æŸ¥èµ„æºæ–‡ä»¶
          $icon_path = "assets/icon/favicon.ico"
          if (-not (Test-Path $icon_path)) {
            Write-Warning "âš ï¸ ä¸»å›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $icon_path"
          } else {
            Write-Host "âœ… æ‰¾åˆ°ä¸»å›¾æ ‡æ–‡ä»¶: $icon_path"
          }
          
          if (-not (Test-Path "assets/icon")) {
            Write-Error "âŒ assets/iconç›®å½•ä¸å­˜åœ¨"
            exit 1
          }
          
          # éªŒè¯ç¼–è¯‘å™¨å¯ç”¨æ€§
          Write-Host "ğŸ”§ éªŒè¯ç¼–è¯‘å™¨ç¯å¢ƒ:"
          try {
            $gccPath = (Get-Command gcc -ErrorAction Stop).Source
            Write-Host "âœ… æ‰¾åˆ°GCC: $gccPath"
            gcc --version | Select-Object -First 1
          } catch {
            Write-Error "âŒ æ— æ³•æ‰¾åˆ°GCCç¼–è¯‘å™¨"
            exit 1
          }
          
          Write-Host "ğŸš€ å¼€å§‹Nuitkaç¼–è¯‘..."
          python -m nuitka --standalone `
            --windows-console-mode=disable `
            --windows-icon-from-ico=$icon_path `
            --include-data-dir=assets/icon=assets/icon `
            --windows-uac-admin `
            --remove-output `
            --enable-plugin=pyside6 `
            --lto=yes `
            --mingw64 `
            --jobs=$env:NUMBER_OF_PROCESSORS `
            --output-filename=ACE-KILLER.exe `
            --product-name="ACE-KILLER" `
            --product-version="${{ github.event.inputs.version }}" `
            --copyright="Copyright (c) 2025 CassianVale" `
            --nofollow-import-to=tkinter,PIL.ImageTk `
            --prefer-source-code `
            --python-flag=no_site `
            --python-flag=no_warnings `
            --report=compilation-report.xml `
            main.py
        shell: pwsh
        env:
          PYTHONIOENCODING: utf-8
          PYTHONLEGACYWINDOWSSTDIO: 1
          ACE_KILLER_VERSION: ${{ github.event.inputs.version }}

      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          Write-Host "ğŸ” éªŒè¯æ„å»ºç»“æœ..."
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          $checks = @(
            @{ Path = "VERSION"; Name = "ç‰ˆæœ¬æ–‡ä»¶" },
            @{ Path = "compilation-report.xml"; Name = "ç¼–è¯‘æŠ¥å‘Š" },
            @{ Path = "main.dist"; Name = "æ„å»ºç›®å½•" },
            @{ Path = "main.dist/ACE-KILLER.exe"; Name = "å¯æ‰§è¡Œæ–‡ä»¶" }
          )
          
          foreach ($check in $checks) {
            if (Test-Path $check.Path) {
              if ($check.Path -eq "main.dist/ACE-KILLER.exe") {
                $fileInfo = Get-Item $check.Path
                $fileSizeMB = [math]::Round($fileInfo.Length / 1MB, 2)
                Write-Host "âœ… $($check.Name) (å¤§å°: ${fileSizeMB} MB)"
              } else {
                Write-Host "âœ… $($check.Name)"
              }
            } else {
              Write-Error "âŒ $($check.Name) æœªæ‰¾åˆ°: $($check.Path)"
              if ($check.Path -eq "main.dist/ACE-KILLER.exe") { exit 1 }
            }
          }
          
          Write-Host "ğŸ‰ æ„å»ºéªŒè¯å®Œæˆï¼"
        shell: pwsh

      - name: ä¸Šä¼ ç¼–è¯‘æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: compilation-report-v${{ github.event.inputs.version }}
          path: compilation-report.xml
          retention-days: 30
          
      - name: å‹ç¼©å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•
        run: |
          $dist_dir = "main.dist"
          $zip_name = "ACE-KILLER-v${{ github.event.inputs.version }}-x64"
          $zip_path = "$zip_name.zip"
          
          if (Test-Path $dist_dir) {
            Compress-Archive -Path "$dist_dir/*" -DestinationPath $zip_path -Force
            if (Test-Path $zip_path) {
              $size_mb = (Get-Item $zip_path).Length / 1MB
              Write-Host "âœ… æˆåŠŸåˆ›å»º $zip_path (å¤§å°: $([math]::Round($size_mb, 2)) MB)"
            } else {
              throw "å‹ç¼©å¤±è´¥ï¼Œæœªç”ŸæˆZIPæ–‡ä»¶"
            }
          } else {
            throw "æ„å»ºç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
          }
        shell: pwsh
        
      - name: åˆ›å»ºå‘å¸ƒ
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: ACE-KILLER v${{ github.event.inputs.version }}
          body: |
            ### ğŸš€ æ›´æ–°æ—¥å¿—
            ${{ github.event.inputs.release_notes }}
            
            ### ğŸ“¥ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `ACE-KILLER-v${{ github.event.inputs.version }}-x64.zip` æ–‡ä»¶
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. å³é”®ç‚¹å‡» `ACE-KILLER.exe`ï¼Œé€‰æ‹©"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
            4. é¦–æ¬¡è¿è¡Œæ—¶ï¼Œå¯åœ¨è®¾ç½®é¡µé¢æ£€æŸ¥æ˜¯å¦ä¸ºæœ€æ–°ç‰ˆæœ¬
            
            ### âš ï¸ ç³»ç»Ÿè¦æ±‚
            - Windows 10/11 x64
            - éœ€è¦ç®¡ç†å‘˜æƒé™
            
            ### ğŸ” å¦‚ä½•æ£€æŸ¥æ›´æ–°
            1. æ‰“å¼€ç¨‹åºä¸»ç•Œé¢
            2. åˆ‡æ¢åˆ°"è®¾ç½®"é€‰é¡¹å¡
            3. ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"æŒ‰é’®
            4. å¦‚æœ‰æ–°ç‰ˆæœ¬ä¼šè‡ªåŠ¨æç¤ºå¹¶å¯ç›´æ¥è·³è½¬ä¸‹è½½
            
          # æ·»åŠ è¦†ç›–é€‰é¡¹
          draft: false
          prerelease: false
          files: |
            ACE-KILLER-v${{ github.event.inputs.version }}-x64.zip