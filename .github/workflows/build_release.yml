name: æ„å»ºå’Œå‘å¸ƒACE-KILLER

permissions:
  contents: write
  packages: write
  
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'
      release_notes:
        description: 'å‘å¸ƒè¯´æ˜'
        required: false
        default: 'æ­¤ç‰ˆæœ¬åŒ…å«æ€§èƒ½æ”¹è¿›å’Œé”™è¯¯ä¿®å¤'

jobs:
  build:
    name: æ„å»ºWindowsåº”ç”¨
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONLEGACYWINDOWSSTDIO: 1
      NUITKA_DOWNLOAD_CONFIRMATION: 1
      PIP_DISABLE_PIP_VERSION_CHECK: 1
      PYTHONOPTIMIZE: 1
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: è®¾ç½®Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: ç¼“å­˜PySide6å’ŒNuitka
        uses: actions/cache@v4
        id: cache-deps
        with:
          path: |
            ~/.cache/pip
            ~/.cache/Nuitka
            ~/.local/share/Nuitka
            ~/AppData/Local/pip/Cache
          key: ${{ runner.os }}-pyside6-nuitka-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pyside6-nuitka-

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip --quiet
          pip install wheel --quiet
          pip install -r requirements.txt --quiet
          pip install nuitka zstandard ordered-set --quiet

      - name: æ›´æ–°ç‰ˆæœ¬å·
        run: |
          # æ›´æ–° VERSION æ–‡ä»¶
          echo "${{ github.event.inputs.version }}" | Out-File -FilePath "VERSION" -Encoding utf8 -NoNewline
          Write-Host "âœ… å·²æ›´æ–° VERSION æ–‡ä»¶ä¸º: ${{ github.event.inputs.version }}"
          
          # æ›´æ–° utils/version_checker.py ä¸­çš„ç‰ˆæœ¬å·
          $versionCheckerPath = "utils/version_checker.py"
          if (Test-Path $versionCheckerPath) {
            (Get-Content -Path $versionCheckerPath -Raw) -replace '__version__ = ".*"', '__version__ = "${{ github.event.inputs.version }}"' | Set-Content -Path $versionCheckerPath -Encoding utf8
            Write-Host "âœ… å·²æ›´æ–° version_checker.py ä¸­çš„ç‰ˆæœ¬å·"
          } else {
            Write-Warning "âš ï¸ æœªæ‰¾åˆ° version_checker.py æ–‡ä»¶"
          }
          
          # éªŒè¯ç‰ˆæœ¬å·æ›´æ–°
          Write-Host "ğŸ“‹ VERSION æ–‡ä»¶å†…å®¹:"
          Get-Content "VERSION"
          
          Write-Host "ğŸ“‹ version_checker.py ä¸­çš„ç‰ˆæœ¬å·:"
          Select-String -Path $versionCheckerPath -Pattern '__version__ = ".*"'
        shell: pwsh
      
      - name: æ¸…ç†æ„å»ºç¯å¢ƒ
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ„å»ºæ–‡ä»¶
          if (Test-Path "main.dist") { Remove-Item -Recurse -Force "main.dist" }
          if (Test-Path "main.build") { Remove-Item -Recurse -Force "main.build" }
          if (Test-Path "main.onefile-build") { Remove-Item -Recurse -Force "main.onefile-build" }
          if (Test-Path "nuitka-crash-report.xml") { Remove-Item -Force "nuitka-crash-report.xml" }
          
          # æ¸…ç†ä¹‹å‰çš„æ—¥å¿—æ–‡ä»¶
          if (Test-Path "nuitka_output.log") { Remove-Item -Force "nuitka_output.log" }
          if (Test-Path "nuitka_error.log") { Remove-Item -Force "nuitka_error.log" }
          
          # æ¸…ç†Pythonç¼“å­˜
          Get-ChildItem -Path . -Recurse -Name "__pycache__" -ErrorAction SilentlyContinue | ForEach-Object { 
            try { Remove-Item -Recurse -Force $_ } catch { Write-Warning "æ— æ³•åˆ é™¤: $_" }
          }
          Get-ChildItem -Path . -Recurse -Name "*.pyc" -ErrorAction SilentlyContinue | ForEach-Object { 
            try { Remove-Item -Force $_ } catch { Write-Warning "æ— æ³•åˆ é™¤: $_" }
          }
          
          # æ¸…ç†ä¸´æ—¶æ„å»ºç›®å½•
          Get-ChildItem -Path $env:TEMP -Name "nuitka_build_*" -ErrorAction SilentlyContinue | ForEach-Object {
            try { Remove-Item -Recurse -Force "$env:TEMP\$_" } catch { Write-Warning "æ— æ³•åˆ é™¤ä¸´æ—¶ç›®å½•: $_" }
          }
          
          Write-Host "âœ… æ„å»ºç¯å¢ƒå·²æ¸…ç†"
        shell: pwsh

      - name: è®¾ç½®Windowsæ„å»ºç¯å¢ƒ
        run: |
          # è®¾ç½®Windowsç¯å¢ƒå˜é‡ä»¥æ”¹å–„æ„å»ºç¨³å®šæ€§
          Write-Host "ğŸ”§ é…ç½®Windowsæ„å»ºç¯å¢ƒ..."
          
          # è®¾ç½®ç¼–è¯‘å™¨ç¯å¢ƒ
          $env:CL = "/MP"  # å¯ç”¨å¤šå¤„ç†å™¨ç¼–è¯‘
          $env:LINK = "/MACHINE:X64"  # æ˜ç¡®æŒ‡å®š64ä½
          
          # è®¾ç½®Nuitkaç¯å¢ƒå˜é‡
          $env:NUITKA_CACHE_DIR = "$env:TEMP\nuitka_cache"
          if (-not (Test-Path $env:NUITKA_CACHE_DIR)) {
            New-Item -ItemType Directory -Path $env:NUITKA_CACHE_DIR -Force | Out-Null
          }
          
          # è®¾ç½®æ›´å¤§çš„å†…å­˜é™åˆ¶
          $env:NUITKA_MEMORY_USAGE = "2048"
          
          # ç¦ç”¨æŸäº›å¯èƒ½å¼•èµ·æƒé™é—®é¢˜çš„åŠŸèƒ½
          $env:NUITKA_DISABLE_CONSOLE_HANDLER = "1"
          
          Write-Host "âœ… Windowsæ„å»ºç¯å¢ƒå·²é…ç½®"
          Write-Host "CL: $env:CL"
          Write-Host "LINK: $env:LINK"
          Write-Host "NUITKA_CACHE_DIR: $env:NUITKA_CACHE_DIR"
          Write-Host "NUITKA_MEMORY_USAGE: $env:NUITKA_MEMORY_USAGE"
        shell: pwsh

      - name: ä½¿ç”¨Nuitkaæ‰“åŒ…åº”ç”¨ç¨‹åº
        run: |
          # è®¾ç½®ç‰ˆæœ¬å·ç¯å¢ƒå˜é‡
          $env:ACE_KILLER_VERSION = "v${{ github.event.inputs.version }}"
          Write-Host "ğŸ”§ è®¾ç½®ç¯å¢ƒå˜é‡ ACE_KILLER_VERSION= v"${{ github.event.inputs.version }}" "
          
          # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
          Write-Host "ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯:"
          Write-Host "OS: $env:OS"
          Write-Host "Processor: $env:PROCESSOR_ARCHITECTURE"
          Write-Host "Username: $env:USERNAME"
          Write-Host "Temp Dir: $env:TEMP"
          Write-Host "Working Dir: $(Get-Location)"
          
          # æ˜¾ç¤ºPythonå’ŒNuitkaç‰ˆæœ¬ä¿¡æ¯
          Write-Host "ğŸ Pythonç‰ˆæœ¬ä¿¡æ¯:"
          python --version
          python -c "import sys; print(f'Pythonè·¯å¾„: {sys.executable}')"
          # ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼è·å–Nuitkaç‰ˆæœ¬ä¿¡æ¯ï¼Œé¿å…__version__å±æ€§é—®é¢˜
          try {
            $nuitkaVersion = python -m nuitka --version 2>&1 | Select-String "Nuitka" | Select-Object -First 1
            if ($nuitkaVersion) {
              Write-Host "Nuitkaç‰ˆæœ¬: $nuitkaVersion"
            } else {
              Write-Host "Nuitkaç‰ˆæœ¬: å·²å®‰è£…ä½†æ— æ³•è·å–ç‰ˆæœ¬ä¿¡æ¯"
            }
          } catch {
            Write-Host "Nuitkaç‰ˆæœ¬: è·å–å¤±è´¥ - $($_.Exception.Message)"
          }
          
          # æ£€æŸ¥ç£ç›˜ç©ºé—´
          Write-Host "ğŸ’¾ ç£ç›˜ç©ºé—´:"
          Get-WmiObject -Class Win32_LogicalDisk | Select-Object DeviceID, @{Name="Size(GB)";Expression={[math]::Round($_.Size/1GB,2)}}, @{Name="FreeSpace(GB)";Expression={[math]::Round($_.FreeSpace/1GB,2)}} | Format-Table
          
          # æ£€æŸ¥èµ„æºæ–‡ä»¶
          $icon_path = "assets/icon/favicon.ico"
          if (-not (Test-Path $icon_path)) {
            Write-Warning "âš ï¸ ä¸»å›¾æ ‡æ–‡ä»¶ä¸å­˜åœ¨: $icon_path"
          } else {
            Write-Host "âœ… æ‰¾åˆ°ä¸»å›¾æ ‡æ–‡ä»¶: $icon_path"
            $iconInfo = Get-Item $icon_path
            Write-Host "ğŸ“Š å›¾æ ‡æ–‡ä»¶ä¿¡æ¯: å¤§å°=${iconInfo.Length}å­—èŠ‚, åˆ›å»ºæ—¶é—´=${iconInfo.CreationTime}"
          }
          
          if (-not (Test-Path "assets/icon")) {
            Write-Error "âŒ assets/iconç›®å½•ä¸å­˜åœ¨"
            exit 1
          } else {
            Write-Host "âœ… æ‰¾åˆ°assets/iconèµ„æºç›®å½•"
            Write-Host "ğŸ“ assets/iconç›®å½•å†…å®¹:"
            Get-ChildItem -Recurse "assets/icon" | Format-Table Name, FullName -AutoSize
          }
          
          # æ£€æŸ¥å½“å‰ç›®å½•æƒé™
          Write-Host "ğŸ” æ£€æŸ¥å½“å‰ç›®å½•æƒé™:"
          $acl = Get-Acl "."
          $acl.Access | Where-Object {$_.IdentityReference -like "*$env:USERNAME*"} | Format-Table IdentityReference, FileSystemRights, AccessControlType
          
          # è®¾ç½®æ›´å®½æ¾çš„ä¸´æ—¶ç›®å½•æƒé™
          Write-Host "ğŸ”§ è®¾ç½®ä¸´æ—¶ç›®å½•:"
          $tempBuildDir = "$env:TEMP\nuitka_build_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
          New-Item -ItemType Directory -Path $tempBuildDir -Force | Out-Null
          Write-Host "ä¸´æ—¶æ„å»ºç›®å½•: $tempBuildDir"
          
          # å¼€å§‹Nuitkaç¼–è¯‘ï¼Œæ·»åŠ è¯¦ç»†æ—¥å¿—
          Write-Host "ğŸš€ å¼€å§‹Nuitkaç¼–è¯‘..."
          
          # ç›´æ¥æ‰§è¡ŒNuitkaå‘½ä»¤ï¼Œé¿å…å‚æ•°ä¼ é€’é—®é¢˜
          Write-Host "ğŸ“‹ æ‰§è¡Œç¼–è¯‘å‘½ä»¤..."
          
          try {
            # ä½¿ç”¨PowerShellçš„è°ƒç”¨æ“ä½œç¬¦ç›´æ¥æ‰§è¡Œ
            & python -m nuitka `
              --standalone `
              --assume-yes-for-downloads `
              --windows-console-mode=disable `
              --windows-icon-from-ico="$icon_path" `
              --include-data-dir=assets/icon=assets/icon `
              --windows-uac-admin `
              --remove-output `
              --enable-plugin=pyside6 `
              --lto=yes `
              --output-filename=ACE-KILLER.exe `
              --product-name="ACE-KILLER" `
              --product-version="${{ github.event.inputs.version }}" `
              --file-version="${{ github.event.inputs.version }}" `
              --file-description="ACE-KILLER - åä½œå¼Šè¿›ç¨‹ä¼˜åŒ–å·¥å…·" `
              --copyright="Â© 2025 CassianVale" `
              --trademarks="ACE-KILLER" `
              --nofollow-import-to=tkinter,PIL.ImageTk `
              --prefer-source-code `
              --python-flag=no_site `
              --python-flag=no_warnings `
              --disable-cache=all `
              --clean-cache=all `
              --show-scons `
              --show-progress `
              --show-memory `
              --report=compilation-report.xml `
              --mingw64 `
              --jobs=$env:NUMBER_OF_PROCESSORS `
              main.py
              
            $exitCode = $LASTEXITCODE
          } catch {
            Write-Host "âŒ æ‰§è¡Œå‘½ä»¤æ—¶å‘ç”Ÿå¼‚å¸¸: $($_.Exception.Message)"
            $exitCode = 1
          }
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if ($exitCode -ne 0) {
            Write-Error "âŒ Nuitkaç¼–è¯‘å¤±è´¥ï¼Œé€€å‡ºä»£ç : $exitCode"
            
            # æ˜¾ç¤ºè¯¦ç»†çš„å´©æºƒæŠ¥å‘Š
            if (Test-Path "nuitka-crash-report.xml") {
              Write-Host "ğŸ“‹ Nuitkaå®Œæ•´å´©æºƒæŠ¥å‘Š:"
              Get-Content "nuitka-crash-report.xml" | ForEach-Object { Write-Host $_ }
            }
            
            # æ˜¾ç¤ºç¼–è¯‘ç¯å¢ƒä¿¡æ¯
            Write-Host "ğŸ” ç¼–è¯‘ç¯å¢ƒè¯Šæ–­ä¿¡æ¯:"
            Write-Host "å½“å‰å·¥ä½œç›®å½•: $(Get-Location)"
            Write-Host "ä¸´æ—¶ç›®å½•: $env:TEMP"
            Write-Host "ç”¨æˆ·å: $env:USERNAME"
            
            # æ£€æŸ¥æ˜¯å¦æœ‰éƒ¨åˆ†æ„å»ºæ–‡ä»¶
            if (Test-Path "main.build") {
              Write-Host "ğŸ“ æ‰¾åˆ°éƒ¨åˆ†æ„å»ºç›®å½•:"
              Get-ChildItem "main.build" -Recurse | Select-Object -First 10 | Format-Table Name, FullName
            }
            
            # æ£€æŸ¥ç£ç›˜ç©ºé—´
            Write-Host "ğŸ’¾ å½“å‰ç£ç›˜ç©ºé—´:"
            Get-WmiObject -Class Win32_LogicalDisk | Where-Object {$_.DeviceID -eq "C:"} | Select-Object @{Name="FreeSpace(GB)";Expression={[math]::Round($_.FreeSpace/1GB,2)}}
            
            exit 1
          }
          
          Write-Host "âœ… Nuitkaç¼–è¯‘å®Œæˆ"
        shell: pwsh
        env:
          PYTHONIOENCODING: utf-8
          PYTHONLEGACYWINDOWSSTDIO: 1
          ACE_KILLER_VERSION: ${{ github.event.inputs.version }}
          CL: /MP
          LINK: /MACHINE:X64
          NUITKA_CACHE_DIR: C:\temp\nuitka_cache
          NUITKA_MEMORY_USAGE: 2048
          NUITKA_DISABLE_CONSOLE_HANDLER: 1

      - name: éªŒè¯æ„å»ºç»“æœ
        run: |
          Write-Host "ğŸ” éªŒè¯æ„å»ºç»“æœ..."
          
          # æ£€æŸ¥ç¯å¢ƒå˜é‡
          Write-Host "ç¯å¢ƒå˜é‡ ACE_KILLER_VERSION: $env:ACE_KILLER_VERSION"
          
          # æ£€æŸ¥VERSIONæ–‡ä»¶
          if (Test-Path "VERSION") {
            $versionFileContent = Get-Content "VERSION" -Raw
            Write-Host "VERSIONæ–‡ä»¶å†…å®¹: '$versionFileContent'"
          }
          
          # æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
          if (Test-Path "main.dist") {
            Write-Host "âœ… æ„å»ºç›®å½•å­˜åœ¨"
            
            # æ£€æŸ¥å¯æ‰§è¡Œæ–‡ä»¶
            if (Test-Path "main.dist/ACE-KILLER.exe") {
              $fileInfo = Get-Item "main.dist/ACE-KILLER.exe"
              $fileSizeMB = [math]::Round($fileInfo.Length / 1MB, 2)
              Write-Host "âœ… å¯æ‰§è¡Œæ–‡ä»¶å·²ç”Ÿæˆ (å¤§å°: ${fileSizeMB} MB)"
            } else {
              Write-Error "âŒ å¯æ‰§è¡Œæ–‡ä»¶æœªæ‰¾åˆ°"
            }
          } else {
            Write-Error "âŒ æ„å»ºç›®å½•æœªæ‰¾åˆ°"
          }
        shell: pwsh
        env:
          ACE_KILLER_VERSION: ${{ github.event.inputs.version }}
          
      - name: å‹ç¼©å¯æ‰§è¡Œæ–‡ä»¶ç›®å½•
        run: |
          $dist_dir = "main.dist"
          $zip_name = "ACE-KILLER-v${{ github.event.inputs.version }}-x64"
          $zip_path = "$zip_name.zip"
          
          if (Test-Path $dist_dir) {
            Compress-Archive -Path "$dist_dir/*" -DestinationPath $zip_path -Force
            if (Test-Path $zip_path) {
              $size_mb = (Get-Item $zip_path).Length / 1MB
              Write-Host "âœ… æˆåŠŸåˆ›å»º $zip_path (å¤§å°: $([math]::Round($size_mb, 2)) MB)"
            } else {
              throw "å‹ç¼©å¤±è´¥ï¼Œæœªç”ŸæˆZIPæ–‡ä»¶"
            }
          } else {
            throw "æ„å»ºç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
          }
        shell: pwsh
        
      - name: åˆ›å»ºå‘å¸ƒ
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: ACE-KILLER v${{ github.event.inputs.version }}
          body: |
            ### ğŸš€ æ›´æ–°æ—¥å¿—
            ${{ github.event.inputs.release_notes }}
            
            ### ğŸ“¥ å®‰è£…è¯´æ˜
            1. ä¸‹è½½ zip å‹ç¼©åŒ…æ–‡ä»¶
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. å³é”®ç‚¹å‡» `ACE-KILLER.exe`ï¼Œé€‰æ‹©"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
            
            ### ğŸ” å¦‚ä½•æ£€æŸ¥æ›´æ–°
            1. æ‰“å¼€ç¨‹åºä¸»ç•Œé¢
            2. åˆ‡æ¢åˆ°"è®¾ç½®"é€‰é¡¹å¡
            3. ç‚¹å‡»"æ£€æŸ¥æ›´æ–°"æŒ‰é’®
            4. å¦‚æœ‰æ–°ç‰ˆæœ¬ä¼šè‡ªåŠ¨æç¤ºå¹¶å¯ç›´æ¥è·³è½¬ä¸‹è½½
            
          # æ·»åŠ è¦†ç›–é€‰é¡¹
          draft: false
          prerelease: false
          files: |
            ACE-KILLER-v${{ github.event.inputs.version }}-x64.zip
